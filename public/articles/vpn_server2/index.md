# Свой VPN, но чуть сложнее | 3X-UI


Дисклеймер: Материл носит исключительно информационный характер. Автор не призывает к каким-либо действиям.

Ага.. снова 3X-UI. Неужели тема не исчерпала себя? Не совсем :) В этой статье из нового разберём следующее: как сделать свой сайт для маскировки и для чего это нужно; что такое WARP и как его настроить; как можно объединить ссылки подписок с нескольких разных серверов; и кучу чего ещё! 

Так что устраивайтесь по-удобнее. А начнём, как и в прошлый раз, с настройки сервера.

{{&lt; admonition type=success title=&#34;Блог для блога&#34; &gt;}}
Подписывайтесь [на мой тгк](https://t.me/hfk_blog), что бы... ну чтобы было ^-^
{{&lt; /admonition &gt;}}

## Настройка VPS
Да-да, тут тоже есть что изменить. В [прошлой статье по настройке своего прокси](https://noisycake.ru/articles/vpn_server/) мы рассмотрели вполне сносный вариант, но совершенству нет предела, ведь так? 

{{&lt; admonition warning &gt;}}
Все действия будут производиться на **Ubuntu 22.04**, поэтому гайд актуален только для неё и ей подобных. Если не в теме, лучшим решением будет установить точно такую же.  
Также хочу сразу предупредить, что это НЕ step-by-step гайд. Большинство действий, которые уже были разобраны в [предыдущей статье](https://noisycake.ru/articles/vpn_server/), здесь не будут описаны столь подробно, дабы излишне не растягивать материал
{{&lt; /admonition &gt;}}

Входим на наш сервер по SSH и обновляем пакеты: `apt update &amp;&amp; apt full-upgrade -y`. 

### Автоматические обновления
По-хорошему нужно сделать так, чтобы обновления безопасности устанавливались автоматически. Для этого выполняем следующее: 
```bash
apt-get install unattended-upgrades
systemctl status unattended-upgrades #Если видим &#34;active(running)&#34; — всё работает
```

### Настройка SSH
Для начала создадим нового пользователя, как делали в прошлый раз:
```bash
adduser &lt;имя_пользователя&gt; #Вводим пароль в соответствующем поле, в остальных вопросах жмём &#34;Enter&#34;
usermod -aG sudo &lt;имя_пользователя&gt;
```

Переходим в конфиг: `nano /etc/ssh/sshd_config` и меняем `Port`; `PermitRootLogin` на &#34;no&#34;; `ClientAliveInterval` и `ClientAliveCountMax` по желанию. Напоминаю, что если перед нужными строками стоит символ &#34;#&#34; — его нужно убрать.

Сохраним изменения и перезапустим утилиту командой `systemctl restart ssh`. Отныне вход на сервер будет осуществляться так: `ssh &lt;имя_пользователя&gt;@&lt;ip_сервера&gt; -p&lt;порт&gt;`.

Теперь сгенерируем SSH-ключи, чтобы входить на сервер без пароля. Во-первых, переходим в PowerShell и пишем `ssh-keygen -t ed25519 -b 4096 -f c:\Users\&lt;имя_пользователя&gt;\.ssh\&lt;имя_ключа&gt;`. Создастся два ключа: публичный и приватный. Переходим по указанному пути, открываем файл `&lt;имя_ключа&gt;.pub` и полностью копируем его содержимое. 

Входим на сервер **под именем созданного пользователя** и выполняем следующие команды:
```bash
mkdir .ssh
cd .ssh
echo ssh-ed25519 &lt;скопированный_текст&gt; &gt;&gt; authorized_keys
```

Открываем конфиг (&#34;/etc/ssh/sshd_config&#34;) и меняем следующие параметры: `PubkeyAuthentication` на &#34;yes&#34;; `PasswordAuthentication` на &#34;no&#34;. Снова сохраняем файл и перезапускаем ssh.

И теперь зайти на сервер можно будет ТОЛЬКО так: `ssh -i &lt;путь_до_файла_на_хосте&gt; &lt;имя_пользователя&gt;@&lt;ip_адрес&gt; -p&lt;порт&gt;`, причём пароль вводить не придётся.  
Зачем мы это сделали? Чтобы избежать брутфорс-атак, да и вообще все умные бородатые дяди говорят, что это канон в обустройстве сервера. И хотя я считаю, что в нашем случае это лишние заморочки, всегда лучше защищаться по-максимуму.

{{&lt; admonition info &gt;}}
**SSH-ключи** — пара файлов, каждый из которых содержит последовательность символов. Один из них, с расширением .pub, является публичным ключом. Он шифрует сообщения, его отправляют на сервера или сетевые службы для дальнейшего взаимодействия. Второй — приватный ключ. Он дешифрует сообщения и хранится на устройстве пользователя.  
Существует несколько криптографических алгоритмов для создания ключей, но сегодня чаще всего используется *ed25519*
{{&lt; /admonition &gt;}}

{{&lt; admonition error &gt;}}
Будьте внимательны, приватные ключи нельзя никуда отправлять! С ним злоумышленники с лёгкостью получат доступ к вашим сервисам
{{&lt; /admonition &gt;}}

## Установка 3x-ui
В этот раз будем устанавливать скриптом, поскольку в контейнере Docker возможности настройки панели слегка ограничены. 

Входим под root и устанавливаем 3x-ui:
```bash
sudo -i
bash &lt;(curl -Ls https://raw.githubusercontent.com/mhsanaei/3x-ui/master/install.sh)`
exit
```

{{&lt; admonition info &gt;}}
Актуальный скрипт всегда можно найти на [Github разработчика](https://github.com/MHSanaei/3x-ui?tab=readme-ov-file#install--upgrade)
{{&lt; /admonition &gt;}}

Над меню управления находится всё, что нам нужно: адрес к панели, логин и пароль, порт. Но заходить в панель мы пока не будем. 

### Установка сертификата
В прошлом гайде мы подключали сертификат уже после того, как настроили панель. Это не есть хорошо. Раз уж мы говорим о безопасности, нужно установить защищённое соединение до ввода каких-либо данных.

В своём [телеграм-канале](https://t.me/hfk_blog) я уже разобрал, как можно провернуть подобный трюк, сейчас же покажу наглядно.

#### Получение домена


#### Способ 1
Данный вариант у меня не сработал, но, думаю, показать его тоже стоит. 

Входим под рут: `sudo -i`, вызываем установленную утилиту: `x-ui`. В выпавшем меню находим &#34;SSL Certificate Management&#34; и пишем соответствующий номер. Выбираем &#34;Get SSL&#34; -&gt; В следующем поле вставляем домен, связанный с ip вашего сервера.

---

> Автор: [NoisyCake](https://t.me/noisycake)  
> URL: http://localhost:1313/articles/vpn_server2/  

